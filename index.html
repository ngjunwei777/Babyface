<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caius AI | Face Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3" crossorigin="anonymous"></script>
    <style>
        :root { --p: #74b9ff; --s: #55efc4; --d: #ff7675; --bg: #0b111a; --glass: rgba(255, 255, 255, 0.05); }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .monitor-frame { position: relative; width: 100%; max-width: 450px; aspect-ratio: 1/1; background: #000; border-radius: 40px; border: 2px solid #1e293b; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* Status Indicator */
        .ai-badge { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.7); padding: 6px 14px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; display: flex; align-items: center; gap: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ff4757; }
        .dot.online { background: #2ed573; box-shadow: 0 0 10px #2ed573; }

        /* Dashboard */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 450px; margin-top: 25px; }
        .card { background: var(--glass); padding: 20px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.08); text-align: center; }
        .card label { font-size: 0.65rem; color: #888; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px; }
        .card b { font-size: 1.2rem; color: var(--s); }

        .btn-start { width: 100%; max-width: 450px; padding: 22px; border-radius: 25px; border: none; background: var(--p); font-weight: 800; font-size: 1.1rem; cursor: pointer; margin-top: 20px; box-shadow: 0 10px 20px rgba(116, 185, 255, 0.2); }
        .alert { color: var(--d) !important; }
        .loading-text { position: absolute; inset: 0; display: flex; items: center; justify-content: center; background: rgba(0,0,0,0.8); z-index: 5; }
    </style>
</head>
<body>

    <header style="text-align:center; margin-bottom: 20px;">
        <div style="font-size: 0.65rem; color: var(--p); letter-spacing: 3px; font-weight: 700;">NG FAMILY MONITOR</div>
        <h1 style="margin: 5px 0; font-size: 1.6rem; font-weight: 800;">Caius AI</h1>
    </header>

    <div class="monitor-frame">
        <div class="ai-badge">
            <div id="status-dot" class="dot"></div>
            <span id="status-text">AI OFFLINE</span>
        </div>
        <div id="loader" class="loading-text" style="display:none;">Loading AI Brain...</div>
        <video id="webcam" autoplay playsinline muted></video>
    </div>

    <div class="dashboard">
        <div class="card"><label>Hunger (Rooting)</label><b id="h-val">---</b></div>
        <div class="card"><label>Crying / Distress</label><b id="c-val">---</b></div>
        <div class="card"><label>Eye State</label><b id="e-val">---</b></div>
        <div class="card"><label>Expression</label><b id="x-val">---</b></div>
    </div>

    <button id="startBtn" class="btn-start">START MONITOR</button>

<script type="module">
    import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

    const video = document.getElementById("webcam");
    const statusDot = document.getElementById("status-dot");
    const statusText = document.getElementById("status-text");
    let faceLandmarker;

    async function start() {
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('loader').style.display = 'flex';

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } } 
            });
            video.srcObject = stream;

            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            
            faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                baseOptions: { 
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
                    delegate: "GPU"
                },
                outputFaceBlendshapes: true,
                runningMode: "VIDEO"
            });

            document.getElementById('loader').style.display = 'none';
            statusDot.classList.add('online');
            statusText.innerText = "AI MONITORING LIVE";
            detect();
        } catch (err) {
            alert("Error: " + err.message);
        }
    }

    function detect() {
        const now = performance.now();
        const results = faceLandmarker.detectForVideo(video, now);

        if (results.faceLandmarks && results.faceLandmarks[0]) {
            const landmarks = results.faceLandmarks[0];
            const blendshapes = results.faceBlendshapes[0].categories;

            // 1. Logic for Hunger (Mouth Stretch + Tongue/Lip Movement)
            const mouthOpen = getShape(blendshapes, "jawOpen");
            const mouthPucker = getShape(blendshapes, "mouthPucker");
            if (mouthPucker > 0.4 || (mouthOpen > 0.1 && mouthOpen < 0.3)) {
                update('h-val', "Searching/Rooting", true);
            } else {
                update('h-val', "Satiated", false);
            }

            // 2. Logic for Crying (Mouth Wide + Brow Lower)
            const browDown = getShape(blendshapes, "browDownLeft");
            if (mouthOpen > 0.5 && browDown > 0.3) {
                update('c-val', "Distress/Crying", true);
            } else {
                update('c-val', "Calm", false);
            }

            // 3. Logic for Sleep
            const eyesClosed = (getShape(blendshapes, "eyeBlinkLeft") + getShape(blendshapes, "eyeBlinkRight")) / 2;
            document.getElementById('e-val').innerText = eyesClosed > 0.6 ? "Eyes Closed" : "Eyes Open";

            // 4. Expression
            const smile = getShape(blendshapes, "mouthSmileLeft");
            document.getElementById('x-val').innerText = smile > 0.3 ? "Happy" : "Neutral";

        } else {
            // No face in frame
            statusText.innerText = "SEARCHING FOR CAIUS...";
        }
        requestAnimationFrame(detect);
    }

    function getShape(shapes, name) {
        const item = shapes.find(c => c.categoryName === name);
        return item ? item.score : 0;
    }

    function update(id, msg, active) {
        const el = document.getElementById(id);
        el.innerText = msg;
        el.className = active ? "alert" : "";
    }

    document.getElementById('startBtn').onclick = start;
</script>
</body>
</html>
