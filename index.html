<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Understanding Caius | by Ng Family</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3"></script>
    <style>
        :root { 
            --brand: #74b9ff; --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --accent: #fdcb6e; --danger: #ff7675; --video-filter: brightness(1) contrast(1);
        }

        /* Night Mode Overrides */
        body.night-mode { --bg: #000000; --card: #111111; --text: #94a3b8; --video-filter: brightness(1.8) contrast(1.2) grayscale(0.5); }

        body { 
            font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); 
            margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; transition: 0.5s;
        }

        .app-container { width: 100%; max-width: 600px; text-align: center; }

        #monitor-window { 
            position: relative; width: 100%; aspect-ratio: 16/9; background: #000; 
            border-radius: 24px; overflow: hidden; border: 4px solid var(--card);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        video, canvas { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            transform: scaleX(-1); filter: var(--video-filter);
        }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; }
        
        button { 
            padding: 16px; border-radius: 14px; border: none; font-weight: bold; 
            cursor: pointer; transition: all 0.2s; font-size: 0.9rem;
        }

        .btn-start { background: var(--brand); color: white; width: 100%; margin-bottom: 10px; }
        .btn-calib { background: var(--accent); color: #2d3436; }
        .btn-night { background: #4b7bec; color: white; }
        
        body.night-mode .btn-night { background: #26de81; color: #000; }

        #status-bar { padding: 10px; font-size: 0.85rem; margin-bottom: 15px; color: var(--accent); }

        .insights { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { background: var(--card); padding: 15px; border-radius: 18px; border: 1px solid #334155; text-align: left; }
        .card small { color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; }
        .card div { font-weight: bold; font-size: 1.1rem; margin-top: 4px; }

        .alert-active { background: #7f1d1d !important; border-color: var(--danger) !important; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.8; } }

        .history { margin-top: 25px; background: var(--card); padding: 20px; border-radius: 20px; text-align: left; }
        #log { max-height: 120px; overflow-y: auto; font-size: 0.85rem; color: #cbd5e1; }
        .log-entry { border-bottom: 1px solid #334155; padding: 6px 0; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1 id="app-title">Understanding Caius</h1>
        <div class="subtitle">By Ng Family • AI Care Assistant</div>
    </header>

    <button id="startBtn" class="btn-start">Start System</button>
    <div id="status-bar">System Offline.</div>

    <div id="monitor-window">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
    </div>

    <div class="controls">
        <button id="calibBtn" class="btn-calib" style="display:none;">Set Baseline</button>
        <button id="nightBtn" class="btn-night" style="display:none;">Night Vision: OFF</button>
    </div>

    <div class="insights">
        <div id="hunger-card" class="card"><small>Hunger</small><div id="h-label">Neutral</div></div>
        <div id="colic-card" class="card"><small>Colic/Gas</small><div id="c-label">Neutral</div></div>
        <div id="tired-card" class="card"><small>State</small><div id="s-label">Awake</div></div>
        <div id="discomfort-card" class="card"><small>Discomfort</small><div id="d-label">Steady</div></div>
    </div>

    <div class="history">
        <div id="log">Logs will appear here...</div>
    </div>
</div>

<script type="module">
    import { FaceLandmarker, PoseLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

    const video = document.getElementById("webcam");
    const status = document.getElementById("status-bar");
    const logContainer = document.getElementById("log");
    const nightBtn = document.getElementById("nightBtn");
    
    let faceLandmarker, poseLandmarker;
    let baseline = { handMouth: 0.5, kneeHip: 0.3, active: false };
    let lastLogTime = 0;

    // Toggle Night Mode
    nightBtn.addEventListener('click', () => {
        document.body.classList.toggle('night-mode');
        const isNight = document.body.classList.contains('night-mode');
        nightBtn.innerText = isNight ? "Night Vision: ON" : "Night Vision: OFF";
    });

    async function startApp() {
        try {
            status.innerText = "Loading AI...";
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            
            faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task" },
                runningMode: "VIDEO"
            });

            poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
                baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker/float16/1/pose_landmarker.task" },
                runningMode: "VIDEO"
            });

            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                status.innerText = "Active. Please Calibrate.";
                document.getElementById('calibBtn').style.display = "block";
                nightBtn.style.display = "block";
                document.getElementById('startBtn').style.display = "none";
                detect();
            };
        } catch (e) {
            status.innerText = "Camera Error. Check HTTPS.";
        }
    }

    function addLog(msg) {
        const now = Date.now();
        if (now - lastLogTime < 10000) return;
        lastLogTime = now;
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `<span>${msg}</span><span style="color:#64748b">${time}</span>`;
        if (logContainer.innerHTML.includes("Logs will")) logContainer.innerHTML = "";
        logContainer.prepend(entry);
    }

    function detect() {
        const startTime = performance.now();
        const faceResults = faceLandmarker.detectForVideo(video, startTime);
        const poseResults = poseLandmarker.detectForVideo(video, startTime);

        if (faceResults.faceLandmarks[0] && poseResults.poseLandmarks[0]) {
            const face = faceResults.faceLandmarks[0];
            const pose = poseResults.poseLandmarks[0];

            const eyeGap = Math.abs(face[159].y - face[145].y);
            const handMouthDist = Math.hypot(pose[16].x - face[13].x, pose[16].y - face[13].y);
            const kneeHipGap = Math.abs(pose[26].y - pose[24].y);

            if (baseline.active) {
                if (handMouthDist < (baseline.handMouth * 0.55)) {
                    trigger('hunger-card', 'h-label', 'Hunger Cue');
                    addLog("Caius hand-to-mouth detected.");
                } else { reset('hunger-card', 'h-label', 'Neutral'); }

                if (kneeHipGap < (baseline.kneeHip * 0.75)) {
                    trigger('colic-card', 'c-label', 'Gas Sign');
                    addLog("Caius knees-to-chest detected.");
                } else { reset('colic-card', 'c-label', 'Neutral'); }

                if (eyeGap < 0.012) {
                    document.getElementById('s-label').innerText = "Sleeping";
                } else { document.getElementById('s-label').innerText = "Awake"; }
            } else {
                baseline.handMouth = handMouthDist;
                baseline.kneeHip = kneeHipGap;
            }
        }
        requestAnimationFrame(detect);
    }

    function trigger(cardId, labelId, msg) {
        document.getElementById(cardId).classList.add('alert-active');
        document.getElementById(labelId).innerText = msg;
    }

    function reset(cardId, labelId, msg) {
        document.getElementById(cardId).classList.remove('alert-active');
        document.getElementById(labelId).innerText = msg;
    }

    document.getElementById('startBtn').addEventListener('click', startApp);
    document.getElementById('calibBtn').addEventListener('click', () => {
        baseline.active = true;
        status.innerText = "✅ Monitoring Active.";
        addLog("Baseline Calibrated.");
    });
</script>
</body>
</html>
